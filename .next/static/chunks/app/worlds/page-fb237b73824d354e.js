(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[542],{243:(e,a,t)=>{"use strict";t.d(a,{E:()=>l});var s=t(5155),r=t(4269);function l(e){let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,r.cn)("animate-pulse rounded-md bg-muted",a),...t})}},508:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});let s=(0,t(1847).A)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},1647:(e,a,t)=>{"use strict";t.d(a,{E:()=>i});var s=t(5155);t(2115);var r=t(3101),l=t(4269);let n=(0,r.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",success:"border-transparent bg-emerald-500/15 text-emerald-700 dark:text-emerald-400",warning:"border-transparent bg-amber-500/15 text-amber-700 dark:text-amber-400"}},defaultVariants:{variant:"default"}});function i(e){let{className:a,variant:t,...r}=e;return(0,s.jsx)("div",{className:(0,l.cn)(n({variant:t}),a),...r})}},1834:(e,a,t)=>{"use strict";t.d(a,{Cf:()=>m,Es:()=>x,L3:()=>h,c7:()=>u,lG:()=>d,rr:()=>f});var s=t(5155),r=t(2115),l=t(3409),n=t(5229),i=t(4269);let d=l.bL;l.l9;let o=l.ZL;l.bm;let c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.hJ,{ref:a,className:(0,i.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...r})});c.displayName=l.hJ.displayName;let m=r.forwardRef((e,a)=>{let{className:t,children:r,...d}=e;return(0,s.jsxs)(o,{children:[(0,s.jsx)(c,{}),(0,s.jsxs)(l.UC,{ref:a,className:(0,i.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...d,children:[r,(0,s.jsxs)(l.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,s.jsx)(n.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});m.displayName=l.UC.displayName;let u=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,i.cn)("flex flex-col space-y-1.5 text-center sm:text-left",a),...t})};u.displayName="DialogHeader";let x=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,i.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...t})};x.displayName="DialogFooter";let h=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.hE,{ref:a,className:(0,i.cn)("text-lg font-semibold leading-none tracking-tight",t),...r})});h.displayName=l.hE.displayName;let f=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.VY,{ref:a,className:(0,i.cn)("text-sm text-muted-foreground",t),...r})});f.displayName=l.VY.displayName},1868:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>H});var s=t(5155),r=t(2115),l=t(7012),n=t(4269),i=t(5142),d=t(3998),o=t(1647),c=t(6948),m=t(243),u=t(8053),x=t(1834),h=t(8640);t(7650);var f=t(2467),p=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((e,a)=>{let t=(0,f.TL)(`Primitive.${a}`),l=r.forwardRef((e,r)=>{let{asChild:l,...n}=e;return"undefined"!=typeof window&&(window[Symbol.for("radix-ui")]=!0),(0,s.jsx)(l?t:a,{...n,ref:r})});return l.displayName=`Primitive.${a}`,{...e,[a]:l}},{}),g=r.forwardRef((e,a)=>(0,s.jsx)(p.label,{...e,ref:a,onMouseDown:a=>{var t;a.target.closest("button, input, select, textarea")||(null==(t=e.onMouseDown)||t.call(e,a),!a.defaultPrevented&&a.detail>1&&a.preventDefault())}}));g.displayName="Label";let v=(0,t(3101).F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),j=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(g,{ref:a,className:(0,n.cn)(v(),t),...r})});j.displayName=g.displayName;var y=t(6767),N=t(1847);let b=(0,N.A)("Unlink",[["path",{d:"m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71",key:"yqzxt4"}],["path",{d:"m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71",key:"4qinb0"}],["line",{x1:"8",x2:"8",y1:"2",y2:"5",key:"1041cp"}],["line",{x1:"2",x2:"5",y1:"8",y2:"8",key:"14m1p5"}],["line",{x1:"16",x2:"16",y1:"19",y2:"22",key:"rzdirn"}],["line",{x1:"19",x2:"22",y1:"16",y2:"16",key:"ox905f"}]]);var w=t(9068);let k=(0,N.A)("BookMarked",[["path",{d:"M10 2v8l3-3 3 3V2",key:"sqw3rj"}],["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var C=t(508),A=t(7586),E=t(6651);let R=(0,N.A)("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);var S=t(5917),z=t(3341),L=t(7937),D=t(7828);let $=(0,N.A)("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);var U=t(1360),T=t(8720);let Z=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("textarea",{className:(0,n.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...r})});Z.displayName="Textarea";var I=t(5626);let M=(0,N.A)("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]),P=(0,N.A)("ToggleRight",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"16",cy:"12",r:"2",key:"4ma0v8"}]]),O=(0,N.A)("ToggleLeft",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"8",cy:"12",r:"2",key:"1nvbw3"}]]);var _=t(6046);let B={0:"Before Char",1:"After Char",2:"Before AN",3:"After AN",4:"@Depth"};function F(e){let{name:a,onBack:t}=e,{data:n,isLoading:h,mutate:f}=(0,l.gf)("/api/worlds/".concat(encodeURIComponent(a))),[p,g]=(0,r.useState)(""),[v,j]=(0,r.useState)(null),[y,N]=(0,r.useState)(null),[b,w]=(0,r.useState)(!1),[k,C]=(0,r.useState)(""),[A,R]=(0,r.useState)(""),[S,z]=(0,r.useState)(""),[L,D]=(0,r.useState)(""),[F,q]=(0,r.useState)(!1),[J,V]=(0,r.useState)(!1),H=(0,r.useMemo)(()=>{if(!n)return[];let e=Object.values(n.entries);if(!p)return e.sort((e,a)=>{var t,s;return(null!=(t=e.displayIndex)?t:e.uid)-(null!=(s=a.displayIndex)?s:a.uid)});let a=p.toLowerCase();return e.filter(e=>{var t,s,r;return(null==(t=e.comment)?void 0:t.toLowerCase().includes(a))||(null==(s=e.key)?void 0:s.some(e=>e.toLowerCase().includes(a)))||(null==(r=e.content)?void 0:r.toLowerCase().includes(a))}).sort((e,a)=>{var t,s;return(null!=(t=e.displayIndex)?t:e.uid)-(null!=(s=a.displayIndex)?s:a.uid)})},[n,p]),G=async()=>{if(v){w(!0);try{await (0,l.mu)("/api/worlds/".concat(encodeURIComponent(a)),{action:"updateEntry",uid:v.uid,updates:{comment:k,key:A.split(",").map(e=>e.trim()).filter(Boolean),keysecondary:S.split(",").map(e=>e.trim()).filter(Boolean),content:L,disable:F,constant:J}}),T.o.success("条目已更新",{description:"原文件已备份"}),f(),j(null)}catch(e){T.o.error("保存失败",{description:String(e)})}finally{w(!1)}}},Y=async()=>{if(null!==y){w(!0);try{await (0,l.mu)("/api/worlds/".concat(encodeURIComponent(a)),{action:"deleteEntry",uid:y}),T.o.success("条目已删除",{description:"原文件已备份"}),f()}catch(e){T.o.error("删除失败",{description:String(e)})}finally{w(!1),N(null)}}};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("div",{className:"flex items-center justify-between",children:(0,s.jsxs)("div",{children:[(0,s.jsxs)(d.$,{variant:"ghost",onClick:t,className:"gap-2 mb-2",children:[(0,s.jsx)(I.A,{className:"h-4 w-4"}),"返回世界书列表"]}),(0,s.jsx)("h2",{className:"text-2xl font-bold tracking-tight",children:a}),(0,s.jsxs)("p",{className:"text-muted-foreground text-sm",children:["共 ",H.length," 个条目"]})]})}),(0,s.jsxs)("div",{className:"relative max-w-sm",children:[(0,s.jsx)(E.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,s.jsx)(i.p,{placeholder:"搜索条目 (标题/关键词/内容)...",value:p,onChange:e=>g(e.target.value),className:"pl-10"})]}),h&&(0,s.jsx)("div",{className:"space-y-2",children:Array.from({length:6}).map((e,a)=>(0,s.jsx)(m.E,{className:"h-24 w-full rounded-lg"},a))}),!h&&(0,s.jsx)("div",{className:"space-y-2",children:H.map(e=>{var a,t;return(0,s.jsx)(c.Zp,{className:"group transition-colors ".concat(e.disable?"opacity-50":""),children:(0,s.jsx)(c.Wu,{className:"p-4",children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1.5",children:[(0,s.jsx)("h4",{className:"font-medium text-sm truncate",children:e.comment||"条目 #".concat(e.uid)}),e.constant&&(0,s.jsx)(o.E,{variant:"success",className:"text-[10px] h-4",children:"常驻"}),e.disable&&(0,s.jsx)(o.E,{variant:"destructive",className:"text-[10px] h-4",children:"禁用"}),e.selective&&(0,s.jsx)(o.E,{variant:"outline",className:"text-[10px] h-4",children:"选择性"}),(0,s.jsxs)(o.E,{variant:"secondary",className:"text-[10px] h-4",children:[B[e.position]||"Pos ".concat(e.position),4===e.position&&" D".concat(e.depth)]})]}),(null==(a=e.key)?void 0:a.length)>0&&(0,s.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5 flex-wrap",children:[(0,s.jsx)(M,{className:"h-3 w-3 text-muted-foreground shrink-0"}),e.key.map((e,a)=>(0,s.jsx)(o.E,{variant:"outline",className:"text-[10px] h-4 font-mono",children:e},a))]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground line-clamp-2",children:(null==(t=e.content)?void 0:t.slice(0,200))||"无内容"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,s.jsx)(d.$,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{var a,t,s,r;j(e),C(e.comment||""),R((null==(a=e.key)?void 0:a.join(", "))||""),z((null==(t=e.keysecondary)?void 0:t.join(", "))||""),D(e.content||""),q(null!=(s=e.disable)&&s),V(null!=(r=e.constant)&&r)},children:(0,s.jsx)($,{className:"h-3.5 w-3.5"})}),(0,s.jsx)(d.$,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>N(e.uid),children:(0,s.jsx)(U.A,{className:"h-3.5 w-3.5 text-destructive"})})]})]})})},e.uid)})}),!h&&0===H.length&&(0,s.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:p?"没有找到匹配的条目":"此世界书没有条目"}),(0,s.jsx)(x.lG,{open:!!v,onOpenChange:()=>j(null),children:(0,s.jsxs)(x.Cf,{className:"max-w-2xl max-h-[85vh] overflow-y-auto",children:[(0,s.jsxs)(x.c7,{children:[(0,s.jsx)(x.L3,{children:"编辑条目"}),(0,s.jsx)(x.rr,{children:"修改世界书条目内容，保存前会自动备份原文件"})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium mb-1.5 block",children:"标题/注释"}),(0,s.jsx)(i.p,{value:k,onChange:e=>C(e.target.value)})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium mb-1.5 block",children:"主关键词 (逗号分隔)"}),(0,s.jsx)(i.p,{value:A,onChange:e=>R(e.target.value),placeholder:"关键词1, 关键词2"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium mb-1.5 block",children:"次要关键词 (逗号分隔)"}),(0,s.jsx)(i.p,{value:S,onChange:e=>z(e.target.value),placeholder:"次要关键词1, 次要关键词2"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium mb-1.5 block",children:"内容"}),(0,s.jsx)(Z,{value:L,onChange:e=>D(e.target.value),rows:10,className:"font-mono text-sm"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-6",children:[(0,s.jsxs)("label",{className:"flex items-center gap-2 text-sm cursor-pointer",onClick:()=>V(!J),children:[J?(0,s.jsx)(P,{className:"h-5 w-5 text-emerald-500"}):(0,s.jsx)(O,{className:"h-5 w-5 text-muted-foreground"}),"常驻激活"]}),(0,s.jsxs)("label",{className:"flex items-center gap-2 text-sm cursor-pointer",onClick:()=>q(!F),children:[F?(0,s.jsx)(P,{className:"h-5 w-5 text-destructive"}):(0,s.jsx)(O,{className:"h-5 w-5 text-muted-foreground"}),"禁用"]})]})]}),(0,s.jsxs)(x.Es,{children:[(0,s.jsx)(d.$,{variant:"outline",onClick:()=>j(null),children:"取消"}),(0,s.jsxs)(d.$,{onClick:G,disabled:b,className:"gap-2",children:[(0,s.jsx)(_.A,{className:"h-4 w-4"}),b?"保存中...":"保存"]})]})]})}),(0,s.jsx)(u.Lt,{open:null!==y,onOpenChange:()=>N(null),children:(0,s.jsxs)(u.EO,{children:[(0,s.jsxs)(u.wd,{children:[(0,s.jsx)(u.r7,{children:"确认删除条目"}),(0,s.jsx)(u.$v,{children:"你确定要删除这个条目吗？世界书文件将在修改前自动备份。"})]}),(0,s.jsxs)(u.ck,{children:[(0,s.jsx)(u.Zr,{disabled:b,children:"取消"}),(0,s.jsx)(u.Rx,{onClick:Y,disabled:b,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:b?"删除中...":"确认删除"})]})]})})]})}function q(e){let{name:a,bindings:t}=e;if(!t)return(0,s.jsx)("div",{className:"mt-1 h-4 w-32 animate-pulse rounded bg-muted"});let r=t[a];if(!r)return(0,s.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,s.jsx)(b,{className:"h-3 w-3 text-muted-foreground/50"}),(0,s.jsx)("span",{className:"text-[11px] text-muted-foreground/60",children:"未绑定任何角色卡或聊天"})]});let{boundCharacters:l,chatCount:n,isGlobal:i,isCharLore:d}=r;if(!(l.length>0||n>0||i||d))return(0,s.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,s.jsx)(b,{className:"h-3 w-3 text-muted-foreground/50"}),(0,s.jsx)("span",{className:"text-[11px] text-muted-foreground/60",children:"未绑定任何角色卡或聊天"})]});let c=l.slice(0,3),m=l.length-3;return(0,s.jsx)(y.TooltipProvider,{delayDuration:200,children:(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-1 mt-1",children:[i&&(0,s.jsxs)(o.E,{variant:"outline",className:"text-[10px] h-4 px-1.5 gap-0.5 border-blue-500/50 text-blue-600 dark:text-blue-400",children:[(0,s.jsx)(w.A,{className:"h-2.5 w-2.5"}),"全局"]}),d&&(0,s.jsxs)(o.E,{variant:"outline",className:"text-[10px] h-4 px-1.5 gap-0.5 border-violet-500/50 text-violet-600 dark:text-violet-400",children:[(0,s.jsx)(k,{className:"h-2.5 w-2.5"}),"附加书"]}),c.map(e=>(0,s.jsxs)(y.m_,{children:[(0,s.jsx)(y.k$,{asChild:!0,children:(0,s.jsxs)(o.E,{variant:"secondary",className:"text-[10px] h-4 px-1.5 gap-0.5 max-w-[120px] cursor-default",children:[(0,s.jsx)(C.A,{className:"h-2.5 w-2.5 shrink-0"}),(0,s.jsx)("span",{className:"truncate",children:e})]})}),(0,s.jsx)(y.ZI,{side:"top",children:e})]},e)),m>0&&(0,s.jsxs)(y.m_,{children:[(0,s.jsx)(y.k$,{asChild:!0,children:(0,s.jsxs)(o.E,{variant:"secondary",className:"text-[10px] h-4 px-1.5 cursor-default",children:["+",m," 个角色卡"]})}),(0,s.jsx)(y.ZI,{side:"top",className:"max-w-xs",children:(0,s.jsx)("div",{className:"space-y-0.5",children:l.slice(3).map(e=>(0,s.jsx)("div",{children:e},e))})})]}),n>0&&(0,s.jsxs)(o.E,{variant:"outline",className:"text-[10px] h-4 px-1.5 gap-0.5 border-emerald-500/50 text-emerald-600 dark:text-emerald-400",children:[(0,s.jsx)(A.A,{className:"h-2.5 w-2.5"}),n," 个聊天"]})]})})}let J=[{value:"newest",label:"最新修改"},{value:"oldest",label:"最早修改"},{value:"name-asc",label:"名称 A→Z"},{value:"name-desc",label:"名称 Z→A"},{value:"entries-most",label:"条目最多"},{value:"entries-least",label:"条目最少"},{value:"chars-most",label:"关联角色最多"},{value:"chats-most",label:"关联聊天最多"}],V=[{value:"all",label:"全部"},{value:"has-bindings",label:"已绑定"},{value:"no-bindings",label:"未绑定"},{value:"global",label:"全局世界书"},{value:"char-lore",label:"附加书"}];function H(){var e,a,t;let{data:f,isLoading:p,mutate:g}=(0,l.gf)("/api/worlds"),{data:v}=(0,l.gf)("/api/worlds/bindings"),[y,N]=(0,r.useState)(""),[b,w]=(0,r.useState)(null),[k,C]=(0,r.useState)(null),[A,Z]=(0,r.useState)(!1),[I,M]=(0,r.useState)(null),[P,O]=(0,r.useState)(""),[_,B]=(0,r.useState)(!1),[H,G]=(0,r.useState)("newest"),[Y,K]=(0,r.useState)("all");(0,r.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("open");e&&(w(e),window.history.replaceState({},"",window.location.pathname))},[]);let Q=(0,r.useMemo)(()=>{if(!f)return[];let e=[...f];if(y){let a=y.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(a))}switch("all"!==Y&&v&&(e=e.filter(e=>{let a=v[e.name];switch(Y){case"has-bindings":return a&&(a.boundCharacters.length>0||a.chatCount>0||a.isGlobal||a.isCharLore);case"no-bindings":return!a||!a.boundCharacters.length&&!a.chatCount&&!a.isGlobal&&!a.isCharLore;case"global":return null==a?void 0:a.isGlobal;case"char-lore":return null==a?void 0:a.isCharLore;default:return!0}})),H){case"newest":e.sort((e,a)=>new Date(a.modified).getTime()-new Date(e.modified).getTime());break;case"oldest":e.sort((e,a)=>new Date(e.modified).getTime()-new Date(a.modified).getTime());break;case"name-asc":e.sort((e,a)=>e.name.localeCompare(a.name,"zh-CN"));break;case"name-desc":e.sort((e,a)=>a.name.localeCompare(e.name,"zh-CN"));break;case"entries-most":e.sort((e,a)=>a.entryCount-e.entryCount);break;case"entries-least":e.sort((e,a)=>e.entryCount-a.entryCount);break;case"chars-most":v&&e.sort((e,a)=>{var t,s,r,l;return(null!=(r=null==(t=v[a.name])?void 0:t.boundCharacters.length)?r:0)-(null!=(l=null==(s=v[e.name])?void 0:s.boundCharacters.length)?l:0)});break;case"chats-most":v&&e.sort((e,a)=>{var t,s,r,l;return(null!=(r=null==(t=v[a.name])?void 0:t.chatCount)?r:0)-(null!=(l=null==(s=v[e.name])?void 0:s.chatCount)?l:0)})}return e},[f,y,H,Y,v]),W=async()=>{if(k){Z(!0);try{await (0,l.Al)("/api/worlds?name=".concat(encodeURIComponent(k))),T.o.success("世界书已删除",{description:"备份已保存到 _manager_backups"}),g()}catch(e){T.o.error("删除失败",{description:String(e)})}finally{Z(!1),C(null)}}},X=async()=>{if(!I||!P.trim())return;let e=P.trim();if(e===I)return void M(null);B(!0);try{let a=await fetch("/api/worlds/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:I,newName:e})}),t=await a.json();if(!a.ok||!t.success)throw Error(t.error||"重命名失败");let s=t.data,r=['世界书已重命名为 "'.concat(e,'"')];s.updatedCharacters.length>0&&r.push("更新了 ".concat(s.updatedCharacters.length," 张角色卡")),s.updatedSettings.length>0&&r.push("更新了设置项"),s.updatedChats.length>0&&r.push("更新了 ".concat(s.updatedChats.length," 个聊天记录")),T.o.success("重命名成功",{description:r.join("，")}),s.errors.length>0&&T.o.warning("部分更新有错误",{description:s.errors.join("\n"),duration:8e3}),g()}catch(e){T.o.error("重命名失败",{description:String(e)})}finally{B(!1),M(null),O("")}};return b?(0,s.jsx)(F,{name:b,onBack:()=>{w(null),g()}}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-3xl font-bold tracking-tight",children:"世界书"}),(0,s.jsxs)("p",{className:"text-muted-foreground mt-1",children:["共 ",null!=(t=null==f?void 0:f.length)?t:0," 本世界书","all"!==Y&&" \xb7 筛选后 ".concat(Q.length," 本")]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3 flex-wrap",children:[(0,s.jsxs)("div",{className:"relative flex-1 max-w-sm",children:[(0,s.jsx)(E.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,s.jsx)(i.p,{placeholder:"搜索世界书...",value:y,onChange:e=>N(e.target.value),className:"pl-10"})]}),(0,s.jsxs)(h.rI,{children:[(0,s.jsx)(h.ty,{asChild:!0,children:(0,s.jsxs)(d.$,{variant:"outline",size:"sm",className:"gap-1.5 shrink-0",children:[(0,s.jsx)(R,{className:"h-3.5 w-3.5"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:null==(e=V.find(e=>e.value===Y))?void 0:e.label})]})}),(0,s.jsx)(h.SQ,{align:"end",className:"w-40",children:V.map(e=>(0,s.jsxs)(h._2,{onClick:()=>K(e.value),className:"gap-2",children:[(0,s.jsx)(S.A,{className:"h-3.5 w-3.5 ".concat(Y===e.value?"opacity-100":"opacity-0")}),e.label]},e.value))})]}),(0,s.jsxs)(h.rI,{children:[(0,s.jsx)(h.ty,{asChild:!0,children:(0,s.jsxs)(d.$,{variant:"outline",size:"sm",className:"gap-1.5 shrink-0",children:[(0,s.jsx)(z.A,{className:"h-3.5 w-3.5"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:null==(a=J.find(e=>e.value===H))?void 0:a.label})]})}),(0,s.jsx)(h.SQ,{align:"end",className:"w-40",children:J.map(e=>(0,s.jsxs)(h._2,{onClick:()=>G(e.value),className:"gap-2",children:[(0,s.jsx)(S.A,{className:"h-3.5 w-3.5 ".concat(H===e.value?"opacity-100":"opacity-0")}),e.label]},e.value))})]})]}),p&&(0,s.jsx)("div",{className:"space-y-2",children:Array.from({length:8}).map((e,a)=>(0,s.jsx)(m.E,{className:"h-16 w-full rounded-lg"},a))}),!p&&(0,s.jsx)("div",{className:"space-y-2",children:Q.map(e=>(0,s.jsx)(c.Zp,{className:"hover:bg-accent/30 transition-colors cursor-pointer group",onClick:()=>w(e.name),children:(0,s.jsxs)(c.Wu,{className:"flex items-center gap-4 p-4",children:[(0,s.jsx)("div",{className:"h-10 w-10 rounded-md bg-emerald-500/10 flex items-center justify-center shrink-0",children:(0,s.jsx)(L.A,{className:"h-5 w-5 text-emerald-500"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("h3",{className:"font-medium text-sm truncate",children:e.name}),(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:[(0,n.v7)(e.size)," \xb7 ",new Date(e.modified).toLocaleDateString("zh-CN")]}),(0,s.jsx)(q,{name:e.name,bindings:v})]}),(0,s.jsxs)(o.E,{variant:"secondary",className:"shrink-0",children:[e.entryCount," 条目"]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,s.jsx)(d.$,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:a=>{a.stopPropagation(),w(e.name)},children:(0,s.jsx)(D.A,{className:"h-4 w-4"})}),(0,s.jsx)(d.$,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:a=>{a.stopPropagation(),M(e.name),O(e.name)},children:(0,s.jsx)($,{className:"h-4 w-4"})}),(0,s.jsx)(d.$,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:a=>{a.stopPropagation(),C(e.name)},children:(0,s.jsx)(U.A,{className:"h-4 w-4 text-destructive"})})]})]})},e.filename))}),!p&&0===Q.length&&(0,s.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:y?"没有找到匹配的世界书":"暂无世界书"}),(0,s.jsx)(u.Lt,{open:!!k,onOpenChange:()=>C(null),children:(0,s.jsxs)(u.EO,{children:[(0,s.jsxs)(u.wd,{children:[(0,s.jsx)(u.r7,{children:"确认删除世界书"}),(0,s.jsxs)(u.$v,{children:["你确定要删除世界书 ",(0,s.jsx)("strong",{children:k})," 吗？",(0,s.jsx)("br",{}),"文件将会被备份到 _manager_backups 目录。"]})]}),(0,s.jsxs)(u.ck,{children:[(0,s.jsx)(u.Zr,{disabled:A,children:"取消"}),(0,s.jsx)(u.Rx,{onClick:W,disabled:A,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:A?"删除中...":"确认删除"})]})]})}),(0,s.jsx)(x.lG,{open:!!I,onOpenChange:e=>{e||(M(null),O(""))},children:(0,s.jsxs)(x.Cf,{className:"sm:max-w-md",children:[(0,s.jsxs)(x.c7,{children:[(0,s.jsx)(x.L3,{children:"重命名世界书"}),(0,s.jsx)(x.rr,{children:"修改名称后，所有绑定该世界书的角色卡、设置和聊天记录中的引用都会自动更新。"})]}),(0,s.jsxs)("div",{className:"space-y-3 py-2",children:[(0,s.jsxs)("div",{className:"space-y-1.5",children:[(0,s.jsx)(j,{className:"text-xs text-muted-foreground",children:"当前名称"}),(0,s.jsx)("div",{className:"px-3 py-2 bg-muted rounded-md text-sm font-mono",children:I})]}),(0,s.jsxs)("div",{className:"space-y-1.5",children:[(0,s.jsx)(j,{htmlFor:"new-name",children:"新名称"}),(0,s.jsx)(i.p,{id:"new-name",value:P,onChange:e=>O(e.target.value),placeholder:"输入新的世界书名称",onKeyDown:e=>{"Enter"===e.key&&P.trim()&&!_&&X()}})]})]}),(0,s.jsxs)(x.Es,{children:[(0,s.jsx)(d.$,{variant:"outline",onClick:()=>{M(null),O("")},disabled:_,children:"取消"}),(0,s.jsx)(d.$,{onClick:X,disabled:_||!P.trim()||P.trim()===I,children:_?"重命名中...":"确认重命名"})]})]})})]})}},3998:(e,a,t)=>{"use strict";t.d(a,{$:()=>o,r:()=>d});var s=t(5155),r=t(2115),l=t(2467),n=t(3101),i=t(4269);let d=(0,n.F)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),o=r.forwardRef((e,a)=>{let{className:t,variant:r,size:n,asChild:o=!1,...c}=e,m=o?l.DX:"button";return(0,s.jsx)(m,{className:(0,i.cn)(d({variant:r,size:n,className:t})),ref:a,...c})});o.displayName="Button"},4269:(e,a,t)=>{"use strict";t.d(a,{Yq:()=>i,cn:()=>l,v7:()=>n});var s=t(2821),r=t(5889);function l(){for(var e=arguments.length,a=Array(e),t=0;t<e;t++)a[t]=arguments[t];return(0,r.QP)((0,s.$)(a))}function n(e){if(0===e)return"0 B";let a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(1))+" "+["B","KB","MB","GB"][a]}function i(e){try{let a=new Date(e);if(isNaN(a.getTime())){let a=e.match(/(\d{4}-\d{2}-\d{2})@(\d{2})h(\d{2})m(\d{2})s/);if(a)return"".concat(a[1]," ").concat(a[2],":").concat(a[3],":").concat(a[4]);return e}return a.toLocaleString("zh-CN")}catch(a){return e}}},5142:(e,a,t)=>{"use strict";t.d(a,{p:()=>n});var s=t(5155),r=t(2115),l=t(4269);let n=r.forwardRef((e,a)=>{let{className:t,type:r,...n}=e;return(0,s.jsx)("input",{type:r,className:(0,l.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...n})});n.displayName="Input"},6046:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});let s=(0,t(1847).A)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},6751:(e,a,t)=>{Promise.resolve().then(t.bind(t,1868))},6767:(e,a,t)=>{"use strict";t.d(a,{TooltipProvider:()=>i,ZI:()=>c,k$:()=>o,m_:()=>d});var s=t(5155),r=t(2115),l=t(1617),n=t(4269);let i=l.Kq,d=l.bL,o=l.l9,c=r.forwardRef((e,a)=>{let{className:t,sideOffset:r=4,...i}=e;return(0,s.jsx)(l.UC,{ref:a,sideOffset:r,className:(0,n.cn)("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...i})});c.displayName=l.UC.displayName},6948:(e,a,t)=>{"use strict";t.d(a,{BT:()=>o,Wu:()=>c,ZB:()=>d,Zp:()=>n,aR:()=>i});var s=t(5155),r=t(2115),l=t(4269);let n=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",t),...r})});n.displayName="Card";let i=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",t),...r})});i.displayName="CardHeader";let d=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("h3",{ref:a,className:(0,l.cn)("text-2xl font-semibold leading-none tracking-tight",t),...r})});d.displayName="CardTitle";let o=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("p",{ref:a,className:(0,l.cn)("text-sm text-muted-foreground",t),...r})});o.displayName="CardDescription";let c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("p-6 pt-0",t),...r})});c.displayName="CardContent",r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("flex items-center p-6 pt-0",t),...r})}).displayName="CardFooter"},7012:(e,a,t)=>{"use strict";t.d(a,{Al:()=>n,gf:()=>l,mu:()=>i});var s=t(7815);let r=async e=>{let a=await fetch(e);if(!a.ok)throw Error("API request failed");let t=await a.json();if(!t.success)throw Error(t.error||"Unknown error");return t.data};function l(e,a){return(0,s.Ay)(e,r,{revalidateOnFocus:!0,dedupingInterval:5e3,keepPreviousData:!0,...a})}async function n(e){let a=await fetch(e,{method:"DELETE"}),t=await a.json();if(!t.success)throw Error(t.error||"Delete failed")}async function i(e,a){let t=await fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),s=await t.json();if(!s.success)throw Error(s.error||"Update failed");return s.data}},8053:(e,a,t)=>{"use strict";t.d(a,{$v:()=>f,EO:()=>m,Lt:()=>d,Rx:()=>p,Zr:()=>g,ck:()=>x,r7:()=>h,wd:()=>u});var s=t(5155),r=t(2115),l=t(2498),n=t(4269),i=t(3998);let d=l.bL;l.l9;let o=l.ZL,c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.hJ,{className:(0,n.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...r,ref:a})});c.displayName=l.hJ.displayName;let m=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsxs)(o,{children:[(0,s.jsx)(c,{}),(0,s.jsx)(l.UC,{ref:a,className:(0,n.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...r})]})});m.displayName=l.UC.displayName;let u=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,n.cn)("flex flex-col space-y-2 text-center sm:text-left",a),...t})},x=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...t})},h=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.hE,{ref:a,className:(0,n.cn)("text-lg font-semibold",t),...r})});h.displayName=l.hE.displayName;let f=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.VY,{ref:a,className:(0,n.cn)("text-sm text-muted-foreground",t),...r})});f.displayName=l.VY.displayName;let p=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.rc,{ref:a,className:(0,n.cn)((0,i.r)(),t),...r})});p.displayName=l.rc.displayName;let g=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.ZD,{ref:a,className:(0,n.cn)((0,i.r)({variant:"outline"}),"mt-2 sm:mt-0",t),...r})});g.displayName=l.ZD.displayName},8640:(e,a,t)=>{"use strict";t.d(a,{SQ:()=>o,_2:()=>c,rI:()=>i,ty:()=>d});var s=t(5155),r=t(2115),l=t(7738),n=t(4269);let i=l.bL,d=l.l9;l.YJ,l.ZL;let o=r.forwardRef((e,a)=>{let{className:t,sideOffset:r=4,...i}=e;return(0,s.jsx)(l.ZL,{children:(0,s.jsx)(l.UC,{ref:a,sideOffset:r,className:(0,n.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...i})})});o.displayName=l.UC.displayName;let c=r.forwardRef((e,a)=>{let{className:t,inset:r,...i}=e;return(0,s.jsx)(l.q7,{ref:a,className:(0,n.cn)("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r&&"pl-8",t),...i})});c.displayName=l.q7.displayName,r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.wv,{ref:a,className:(0,n.cn)("-mx-1 my-1 h-px bg-muted",t),...r})}).displayName=l.wv.displayName,r.forwardRef((e,a)=>{let{className:t,inset:r,...i}=e;return(0,s.jsx)(l.JU,{ref:a,className:(0,n.cn)("px-2 py-1.5 text-sm font-semibold",r&&"pl-8",t),...i})}).displayName=l.JU.displayName}},e=>{e.O(0,[545,815,720,107,297,211,776,617,441,255,358],()=>e(e.s=6751)),_N_E=e.O()}]);